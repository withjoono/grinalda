// ===========================================
// Hub Backend - Prisma Schema
// TypeORM에서 마이그레이션됨
// ===========================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["hub"]
}

// ===================================================
// Member (회원) 도메인
// ===================================================

model AuthMember {
  id                    String  @id @db.VarChar(30)
  email                 String  @db.VarChar(500)
  password              String? @db.VarChar(500)
  role_type             String  @db.VarChar(500)
  phone                 String  @db.VarChar(255)
  ck_sms                Boolean @default(false)
  ck_sms_agree          Boolean @default(false)
  nickname              String? @db.VarChar(255)
  member_type           String  @default("student") @db.VarChar(20)
  profile_image_url     String? @db.VarChar(4000)
  provider_type         String? @db.VarChar(20)
  oauth_id              String? @db.VarChar(500)
  firebase_uid          String? @db.VarChar(128)
  user_type_code        String? @db.VarChar(5)
  user_type_detail_code String? @db.VarChar(5)
  reg_year              Int?
  reg_month             String? @db.VarChar(2)
  reg_day               String? @db.VarChar(2)
  account_stop_yn       String  @default("N") @db.VarChar(1)
  create_dt             DateTime? @db.Timestamp()
  update_dt             DateTime? @db.Timestamp()

  // Relations
  studentProfile     AuthMemberStudent?
  teacherProfile     AuthMemberTeacher?
  parentProfile      AuthMemberParent?
  interests          UserUniversityInterest[]
  orders             PaymentOrder[]
  posts              Post[]
  comments           Comment[]
  authorizationCodes OAuthAuthorizationCode[]
  subscriptions      HubAppSubscription[]
  selectSubjects     SgbSelectSubject[]
  subjectLearnings   SgbSubjectLearning[]
  volunteers         SgbVolunteer[]
  sportsArts         SgbSportsArt[]
  creativeActivities SgbCreativeActivity[]
  behaviorOpinions   SgbBehaviorOpinion[]
  attendances        SgbAttendance[]
  contracts          PaymentContract[]

  @@index([email, phone, oauth_id])
  @@index([firebase_uid], map: "idx_member_firebase_uid")
  @@map("auth_member")
  @@schema("hub")
}

model AuthMemberStudent {
  member_id       String  @id @db.VarChar(30)
  school_code     String? @db.VarChar(20)
  school_name     String? @db.VarChar(100)
  school_location String? @db.VarChar(50)
  school_type     String? @db.VarChar(50)
  school_level    String? @db.VarChar(10)
  grade           Int?

  member AuthMember @relation(fields: [member_id], references: [id], onDelete: Cascade)

  @@map("auth_member_s")
  @@schema("hub")
}

model AuthMemberTeacher {
  member_id    String  @id @db.VarChar(30)
  school_level String? @db.VarChar(10)
  subject      String? @db.VarChar(50)

  member AuthMember @relation(fields: [member_id], references: [id], onDelete: Cascade)

  @@map("auth_member_t")
  @@schema("hub")
}

model AuthMemberParent {
  member_id   String  @id @db.VarChar(30)
  parent_type String? @db.VarChar(20)

  member AuthMember @relation(fields: [member_id], references: [id], onDelete: Cascade)

  @@map("auth_member_p")
  @@schema("hub")
}

model UserUniversityInterest {
  id            Int      @id @default(autoincrement())
  member_id     String   @db.VarChar(30)
  target_table  String   @db.VarChar(50)
  target_id     BigInt
  evaluation_id Int?
  created_at    DateTime @default(now())

  member AuthMember @relation(fields: [member_id], references: [id])

  @@map("ss_user_university_interest")
  @@schema("hub")
}

model AuthMemberFile {
  id        BigInt   @id @default(autoincrement())
  create_dt DateTime @default(now())
  file_key  String   @db.VarChar(500)
  file_name String   @db.VarChar(500)
  file_path String   @db.VarChar(500)
  file_size Int?
  file_type String   @db.VarChar(500)
  member_id String   @db.VarChar(30)
  update_dt DateTime @updatedAt

  @@map("auth_member_file")
  @@schema("hub")
}

// ===================================================
// Payment (결제) 도메인
// ===================================================

model PaymentService {
  id                   BigInt    @id @default(autoincrement())
  create_dt            DateTime? @db.Timestamp()
  explain_comment      String?   @db.VarChar(3000)
  product_image        String?   @db.VarChar(3000)
  product_nm           String    @unique(map: "UK_pk3sdbagrh1cdo8jk2oog4g0v") @db.VarChar(500)
  product_payment_type String?   @db.VarChar(500)
  product_price        String    @db.VarChar(500)
  promotion_discount   Float     @default(0)
  term                 DateTime? @db.Timestamp()
  update_dt            DateTime? @db.Timestamp()
  refund_policy        String?   @db.VarChar(1000)
  delete_flag          Int       @default(0)
  product_cate_code    String?   @db.VarChar(45)
  product_type_code    String?   @db.VarChar(45)
  service_range_code   String?   @db.VarChar(45)
  available_count      Int?
  available_term       String?   @db.VarChar(45)

  orders          PaymentOrder[]
  coupons         PaymentCoupon[]
  serviceProducts PaymentServiceProduct[]

  @@map("payment_service")
  @@schema("hub")
}

model PaymentCoupon {
  id                  BigInt  @id @default(autoincrement())
  coupon_number       String  @db.VarChar(500)
  discount_info       String  @db.VarChar(500)
  discount_value      Int
  number_of_available Int     @default(0)
  pay_service_id      BigInt?

  pay_service PaymentService? @relation(fields: [pay_service_id], references: [id])

  @@map("payment_coupon")
  @@schema("hub")
}

model PaymentContract {
  id                     BigInt    @id @default(autoincrement())
  contract_period_end_dt DateTime  @db.Timestamp()
  contract_start_dt      DateTime  @db.Timestamp()
  contract_use           Int?
  create_dt              DateTime? @db.Timestamp()
  product_code           String    @db.VarChar(200)
  regular_contract_fl    Boolean
  update_dt              DateTime? @db.Timestamp()
  member_id              String?   @db.VarChar(30)
  order_id               BigInt?

  member AuthMember?   @relation(fields: [member_id], references: [id])
  order  PaymentOrder? @relation(fields: [order_id], references: [id])

  @@map("payment_contract")
  @@schema("hub")
}

model PaymentOrder {
  id             BigInt    @id @default(autoincrement())
  cancel_amount  Int       @default(0)
  emb_pg_provider String?  @db.VarChar(500)
  card_name      String?   @db.VarChar(500)
  card_number    String?   @db.VarChar(500)
  contract_id    BigInt?
  create_dt      DateTime? @db.Timestamp()
  imp_uid        String?   @unique(map: "UK_gnwosnxtfwcpt1acvc9c1t1vf") @db.VarChar(500)
  member_id      String?   @db.VarChar(30)
  merchant_uid   String    @unique(map: "UK_4c9pqmv7an15g602u8wa6dje") @db.VarChar(500)
  order_state    String    @db.VarChar(20)
  paid_amount    Int?
  update_dt      DateTime? @db.Timestamp()
  vbank_code     String?   @db.VarChar(500)
  vbank_name     String?   @db.VarChar(500)
  pay_service_id BigInt?

  member      AuthMember?     @relation(fields: [member_id], references: [id])
  pay_service PaymentService? @relation(fields: [pay_service_id], references: [id])
  contracts   PaymentContract[]

  @@map("payment_order")
  @@schema("hub")
}

model PaymentCancelLog {
  id            BigInt    @id @default(autoincrement())
  cancel_reason String?   @db.VarChar(500)
  code          String    @db.VarChar(500)
  fail_reason   String?   @db.VarChar(500)
  imp_uid       String    @db.VarChar(500)
  merchant_uid  String    @db.VarChar(500)
  pay_amount    String    @db.VarChar(500)
  pay_method    String?   @db.VarChar(500)
  result_msg    String?   @db.VarChar(500)
  status        String?   @db.VarChar(500)
  create_dt     DateTime? @db.Timestamp()
  update_dt     DateTime? @db.Timestamp()

  @@map("payment_cancel_log")
  @@schema("hub")
}

model PaymentProduct {
  id           BigInt @id @default(autoincrement())
  product_name String @map("product_name") @db.VarChar(500)
  product_code String @unique @map("product_code") @db.VarChar(500)
  product_type String @map("product_type") @db.VarChar(500)

  serviceProducts PaymentServiceProduct[]

  @@map("payment_product")
  @@schema("hub")
}

model PaymentServiceProduct {
  id             BigInt @id @default(autoincrement())
  pay_service_id BigInt @map("pay_service_id")
  pay_product_id BigInt @map("pay_product_id")

  service PaymentService @relation(fields: [pay_service_id], references: [id])
  product PaymentProduct @relation(fields: [pay_product_id], references: [id])

  @@map("payment_service_product")
  @@schema("hub")
}

// ===================================================
// Board (게시판) 도메인
// ===================================================

model Board {
  id         Int    @id @default(autoincrement())
  name       String @db.VarChar(255)
  permission String @db.VarChar(50)

  posts Post[]

  @@map("board_board")
  @@schema("hub")
}

model Post {
  id            BigInt   @id @default(autoincrement())
  title         String   @db.VarChar(255)
  content       String   @db.Text
  created_at    DateTime @default(now()) @db.Timestamp()
  updated_at    DateTime @updatedAt @db.Timestamp()
  is_emphasized Boolean  @default(false)
  board_id      Int?
  member_id     String?  @db.VarChar(30)

  board    Board?      @relation(fields: [board_id], references: [id])
  member   AuthMember? @relation(fields: [member_id], references: [id])
  comments Comment[]

  @@map("board_post")
  @@schema("hub")
}

model Comment {
  id         BigInt   @id @default(autoincrement())
  content    String   @db.Text
  created_at DateTime @default(now()) @db.Timestamp()
  updated_at DateTime @updatedAt @db.Timestamp()
  post_id    BigInt?
  member_id  String?  @db.VarChar(30)

  post   Post?       @relation(fields: [post_id], references: [id])
  member AuthMember? @relation(fields: [member_id], references: [id])

  @@map("board_comment")
  @@schema("hub")
}

// ===================================================
// OAuth 2.0 도메인
// ===================================================

model OAuthClient {
  id            Int      @id @default(autoincrement())
  clientId      String   @unique @map("clientId") @db.VarChar(255)
  clientSecret  String?  @map("clientSecret") @db.VarChar(255)
  clientName    String   @map("clientName") @db.VarChar(255)
  redirectUris  String[] @map("redirectUris")
  allowedScopes String[] @map("allowedScopes") @db.VarChar(255)
  isActive      Boolean  @default(true) @map("isActive")
  createdAt     DateTime @default(now()) @map("createdAt") @db.Timestamp()
  updatedAt     DateTime @updatedAt @map("updatedAt") @db.Timestamp()

  authorizationCodes OAuthAuthorizationCode[]

  @@map("oauth_clients")
  @@schema("hub")
}

model OAuthAuthorizationCode {
  id                  Int      @id @default(autoincrement())
  code                String   @unique @db.VarChar(255)
  clientId            String   @map("clientId") @db.VarChar(255)
  memberId            String   @map("memberId") @db.VarChar(30)
  redirectUri         String   @map("redirectUri") @db.Text
  scope               String[] @map("scope") @db.VarChar(255)
  codeChallenge       String?  @map("codeChallenge") @db.VarChar(255)
  codeChallengeMethod String?  @map("codeChallengeMethod") @db.VarChar(10)
  expiresAt           DateTime @map("expiresAt") @db.Timestamp()
  isUsed              Boolean  @default(false) @map("isUsed")
  createdAt           DateTime @default(now()) @map("createdAt") @db.Timestamp()

  client OAuthClient @relation(fields: [clientId], references: [clientId])
  member AuthMember  @relation(fields: [memberId], references: [id])

  @@index([code])
  @@index([expiresAt])
  @@map("oauth_authorization_codes")
  @@schema("hub")
}

// ===================================================
// Subscription (구독/권한) 도메인
// ===================================================

model HubApp {
  id          String   @id @db.VarChar(50)
  name        String   @db.VarChar(100)
  description String?  @db.VarChar(500)
  icon_url    String?  @db.VarChar(500)
  app_url     String?  @db.VarChar(255)
  is_active   Boolean  @default(true)
  pricing     Json?
  features    Json?
  sort_order  Int      @default(0)
  created_at  DateTime @default(now()) @db.Timestamp()
  updated_at  DateTime @updatedAt @db.Timestamp()

  subscriptions HubAppSubscription[]

  @@map("hub_apps")
  @@schema("hub")
}

model HubAppSubscription {
  id               BigInt    @id @default(autoincrement())
  member_id        String    @db.VarChar(30)
  app_id           String    @db.VarChar(50)
  plan             String    @default("free") @db.VarChar(20)
  status           String    @default("active") @db.VarChar(20)
  started_at       DateTime? @db.Timestamp()
  expires_at       DateTime? @db.Timestamp()
  payment_order_id BigInt?
  features         Json?
  usage_count      Int       @default(0)
  usage_limit      Int?
  auto_renew       Boolean   @default(false)
  created_at       DateTime  @default(now()) @db.Timestamp()
  updated_at       DateTime  @updatedAt @db.Timestamp()

  app    HubApp     @relation(fields: [app_id], references: [id])
  member AuthMember @relation(fields: [member_id], references: [id])

  @@unique([member_id, app_id])
  @@map("hub_app_subscriptions")
  @@schema("hub")
}

model HubProductPermissionMapping {
  id                  BigInt   @id @default(autoincrement())
  app_id              String   @db.VarChar(50)
  external_product_id String   @db.VarChar(100)
  product_name        String   @db.VarChar(200)
  plan                String   @default("premium") @db.VarChar(20)
  features            Json
  duration_days       Int?
  usage_limit         Int?
  is_active           Boolean  @default(true)
  memo                String?  @db.Text
  created_at          DateTime @default(now()) @db.Timestamp()
  updated_at          DateTime @updatedAt @db.Timestamp()

  @@unique([app_id, external_product_id])
  @@map("hub_product_permission_mappings")
  @@schema("hub")
}

// ===================================================
// School Record (생기부) 도메인
// ===================================================

model SgbSelectSubject {
  id                   Int     @id @default(autoincrement())
  achievement          String? @db.Text
  achievementa         String? @db.Text
  achievementb         String? @db.Text
  achievementc         String? @db.Text
  detail_and_specialty String? @db.Text
  etc                  String? @db.Text
  grade                String? @db.Text
  main_subject_code    String? @db.Text
  main_subject_name    String  @db.Text
  raw_score            String? @db.Text
  semester             String? @db.Text
  students_num         String? @db.Text
  sub_subject_average  String? @db.Text
  subject_code         String? @db.Text
  subject_name         String  @db.Text
  unit                 String? @db.Text
  member_id            String? @db.VarChar(30)

  member AuthMember? @relation(fields: [member_id], references: [id])

  @@map("sgb_select_subject")
  @@schema("hub")
}

model SgbSubjectLearning {
  id                   Int     @id @default(autoincrement())
  achievement          String? @db.VarChar(1000)
  detail_and_specialty String? @db.Text
  etc                  String? @db.VarChar(1000)
  grade                String? @db.VarChar(1000)
  main_subject_code    String? @db.VarChar(1000)
  main_subject_name    String  @db.VarChar(1000)
  ranking              String? @db.VarChar(1000)
  raw_score            String? @db.VarChar(1000)
  semester             String? @db.VarChar(1000)
  standard_deviation   String? @db.VarChar(1000)
  students_num         String? @db.VarChar(1000)
  sub_subject_average  String? @db.VarChar(1000)
  subject_code         String? @db.VarChar(1000)
  subject_name         String? @db.VarChar(1000)
  unit                 String? @db.VarChar(1000)
  member_id            String? @db.VarChar(30)

  member AuthMember? @relation(fields: [member_id], references: [id])

  @@map("sgb_subject_learning")
  @@schema("hub")
}

model SgbVolunteer {
  id               Int     @id @default(autoincrement())
  accumulate_time  String? @db.VarChar(1000)
  activity_content String? @db.VarChar(1000)
  activity_time    String? @db.VarChar(1000)
  date             String? @db.VarChar(1000)
  grade            String? @db.VarChar(1000)
  place            String? @db.VarChar(1000)
  member_id        String? @db.VarChar(30)

  member AuthMember? @relation(fields: [member_id], references: [id])

  @@map("sgb_volunteer")
  @@schema("hub")
}

model SgbSportsArt {
  id          BigInt  @id @default(autoincrement())
  achievement String? @db.Text
  etc         String? @db.Text
  grade       String? @db.Text
  semester    String? @db.Text
  sub_subject String? @db.Text
  subject     String? @db.Text
  unit        String? @db.Text
  member_id   String? @db.VarChar(30)

  member AuthMember? @relation(fields: [member_id], references: [id])

  @@map("sgb_sport_art")
  @@schema("hub")
}

model SgbCreativeActivity {
  id            BigInt  @id @default(autoincrement())
  grade         String? @db.Text
  activity_type String? @db.Text
  content       String? @db.Text
  member_id     String? @db.VarChar(30)

  member AuthMember? @relation(fields: [member_id], references: [id])

  @@map("sgb_creative_activity")
  @@schema("hub")
}

model SgbBehaviorOpinion {
  id        BigInt  @id @default(autoincrement())
  grade     String? @db.Text
  content   String? @db.Text
  member_id String? @db.VarChar(30)

  member AuthMember? @relation(fields: [member_id], references: [id])

  @@map("sgb_behavior_opinion")
  @@schema("hub")
}

model SgbAttendance {
  id                       Int     @id @default(autoincrement())
  absent_disease           Int?
  absent_etc               Int?
  absent_unrecognized      Int?
  class_days               Int?
  etc                      String? @db.Text
  grade                    String? @db.VarChar(1000)
  late_disease             Int?
  late_etc                 Int?
  late_unrecognized        Int?
  leave_early_disease      Int?
  leave_early_etc          Int?
  leave_early_unrecognized Int?
  result_disease           Int?
  result_early_etc         Int?
  result_unrecognized      Int?
  member_id                String? @db.VarChar(30)

  member AuthMember? @relation(fields: [member_id], references: [id])

  @@map("sgb_attendance")
  @@schema("hub")
}

// ===================================================
// Common Code (공통 코드) 도메인
// ===================================================

model SubjectCodeList {
  id                BigInt  @id @default(autoincrement())
  main_subject_code String  @db.VarChar(500)
  main_subject_name String  @db.VarChar(500)
  subject_code      String  @db.VarChar(500)
  subject_name      String  @db.VarChar(500)
  type              Int?
  course_type       Int     @default(0) @db.SmallInt
  is_required       Boolean @default(false)

  @@map("earlyd_subject_code_list_tb")
  @@schema("hub")
}

model Hub2015KyokwaSubject {
  id                  String  @id @db.VarChar(20)
  kyokwa              String  @db.VarChar(50)
  kyokwa_code         String  @db.VarChar(10)
  classification      String  @db.VarChar(50)
  classification_code Int
  subject_name        String  @db.VarChar(100)
  subject_code        Int
  evaluation_method   String? @db.VarChar(50)

  @@map("hub_2015_kyokwa_subject")
  @@schema("hub")
}

model Hub2022KyokwaSubject {
  id                  String  @id @db.VarChar(20)
  kyokwa              String  @db.VarChar(50)
  kyokwa_code         String  @db.VarChar(10)
  classification      String  @db.VarChar(50)
  classification_code Int
  subject_name        String  @db.VarChar(100)
  subject_code        Int
  evaluation_method   String? @db.VarChar(50)

  @@map("hub_2022_kyokwa_subject")
  @@schema("hub")
}
